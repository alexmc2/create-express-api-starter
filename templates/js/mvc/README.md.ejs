# <%= projectName %>

Express API starter generated by `@alexmc2/create-express-api-starter`.

## Selected options

- Language: <%= languageLabel %>
- Module system: <%= moduleSystemLabel %>
- Dev watcher: <%= jsDevWatcherLabel %>
- Architecture: <%= architectureLabel %>
- Database: <%= databaseLabel %>
- Educational comments: <%= educationalLabel %>

## Folder structure

```
.
├── src
│   ├── app.js
│   ├── server.js
│   ├── routes
│   │   ├── health.js
│   │   └── users.js
│   ├── controllers
│   │   └── usersController.js
│   ├── services
│   │   └── usersService.js
│   ├── repositories
│   │   └── usersRepository.js
<% if (isPostgres) { %>│   ├── db
│   │   └── pool.js
<% } %>│   ├── errors
│   │   └── AppError.js
│   ├── utils
│   │   └── getPort.js
│   └── middleware
│       ├── errorHandler.js
│       └── notFound.js
├── __tests__
│   └── app.test.js
<% if (isPostgres) { %>├── db
│   ├── schema.sql
│   └── seed.sql
<% } %><% if (isPostgres) { %>├── scripts
<% if (isPsql) { %>│   ├── dbCreate.js
<% } %>│   ├── dbSetup.js
│   ├── dbSeed.js
│   └── dbReset.js
<% } %><% if (isDocker) { %>├── compose.yaml
<% } %>├── .env.example
├── .gitignore
├── package.json
└── jest.config.js
```

<% if (isPsql) { %>
## Prerequisites

This project uses a local PostgreSQL database. Follow the steps for your OS below.

### 1. Install PostgreSQL

**macOS** (using [Homebrew](https://brew.sh)):

```sh
brew install postgresql@17
brew services start postgresql@17
```

**Ubuntu / Debian**:

```sh
sudo apt update && sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql && sudo systemctl enable postgresql
```

**Windows**: Download the installer from https://www.postgresql.org/download/windows/ and follow the prompts. Remember the password you set — you'll need it in step 2.

### 2. Set up your database role

Your `.env` file connects as `<%= osUsername %>` with password `postgres`. You need a matching PostgreSQL role.

**Linux** (run once):

```sh
sudo -u postgres createuser --createdb "$USER"
sudo -u postgres psql -c "ALTER USER \"$USER\" WITH PASSWORD 'postgres';"
```

**macOS**: Homebrew already created a role for you. Run the commands above only if you get an auth error.

**Windows**: The installer created a `postgres` role. Edit `DATABASE_URL` in your `.env` to use it:

```
DATABASE_URL=postgres://postgres:YOUR_INSTALL_PASSWORD@localhost:5432/<%= databaseName %>
```

### 3. Verify

```sh
pg_isready
```

You should see `accepting connections`.
<% } %>
<% if (isDocker) { %>
## Prerequisites

This project uses PostgreSQL in a Docker container. Install [Docker Desktop](https://docs.docker.com/get-docker/) and make sure it's running before continuing.
<% } %>

## Run the app

```sh
npm install
cp .env.example .env
<% if (isPsql) { %>npm run db:create
npm run db:setup
npm run db:seed
<% } else if (isDocker) { %>npm run db:up
npm run db:setup
npm run db:seed
<% } %>npm run dev
```

## Add a new route

1. Create a router file in `src/routes`.
2. Add a controller function in `src/controllers`.
3. Add business logic in `src/services`.
4. Register the route in `src/app.js`.

## Where business logic goes

Put business rules in `src/services`. Controllers focus on HTTP concerns, and repositories only handle data access.

## How errors work

- `src/middleware/notFound.js` handles unknown routes with a 404 JSON response.
- `src/middleware/errorHandler.js` returns `{ status, message }` and includes `stack` only in development.

<% if (isPsql) { %>
## Database commands

| Command | What it does |
| --- | --- |
| `npm run db:create` | Creates the database (safe to re-run) |
| `npm run db:setup` | Applies the schema (creates tables) |
| `npm run db:seed` | Inserts sample data |
| `npm run db:reset` | Drops and re-creates tables + sample data |

## Troubleshooting

**"connection refused"** — PostgreSQL isn't running.

```sh
# Linux
sudo systemctl start postgresql
# macOS
brew services start postgresql@17
```

**"role does not exist"** — Create a Postgres role for your OS user:

```sh
sudo -u postgres createuser --createdb "$USER"
sudo -u postgres psql -c "ALTER USER \"$USER\" WITH PASSWORD 'postgres';"
```

**"password authentication failed" / "client password must be a string"** — The credentials in `DATABASE_URL` are wrong or missing. Run the role setup commands in [Prerequisites](#prerequisites) and make sure `DATABASE_URL` in `.env` matches.

**"database does not exist"** — Run `npm run db:create`.
<% } %>
<% if (isDocker) { %>
## Database commands

| Command | What it does |
| --- | --- |
| `npm run db:up` | Starts the Postgres Docker container |
| `npm run db:down` | Stops the container |
| `npm run db:setup` | Applies the schema (creates tables) |
| `npm run db:seed` | Inserts sample data |
| `npm run db:reset` | Stops container, restarts, re-applies schema + seed |
<% } %>

**"EADDRINUSE: address already in use"** — Another process is using port 3000. Check your other terminal windows for a running server and stop it with `Ctrl+C`.
