<% if (educational) { %>// File overview: Runs db/schema.sql to create or reset database tables.
<% } %>
<% if (isEsm) { %>import 'dotenv/config';

import fs from 'node:fs/promises';
import path from 'node:path';

import { Pool } from 'pg';
<% } else { %>require('dotenv').config();

const fs = require('node:fs/promises');
const path = require('node:path');
const { Pool } = require('pg');
<% } %>
<% if (isDocker) { %>
const RETRIES = 20;
const RETRY_DELAY_MS = 1000;

<% if (educational) { %>// Sleep helper used between retry attempts while the container starts.
<% } %>function sleep(ms) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

<% if (educational) { %>// Retry a simple query until PostgreSQL is ready to accept commands.
<% } %>async function waitForDatabase(pool) {
  for (let attempt = 1; attempt <= RETRIES; attempt += 1) {
    try {
      await pool.query('SELECT 1');
      return;
    } catch {
      console.log('Waiting for database...');
      await sleep(RETRY_DELAY_MS);
    }
  }

  throw new Error('Unable to connect to database after 20 retries.');
}
<% } %>
<% if (educational) { %>// Read db/schema.sql and apply it to the configured database.
<% } %>async function run() {
  const databaseUrl = process.env.DATABASE_URL;

  if (!databaseUrl) {
    console.error('Error: DATABASE_URL is not set.');
    console.error('Make sure you have a .env file with DATABASE_URL defined.');
    console.error('You can copy .env.example to .env to get started.');
    process.exit(1);
  }

  const pool = new Pool({ connectionString: databaseUrl });

  try {
<% if (isDocker) { %><% if (educational) { %>    // Docker containers may need a few seconds before accepting connections.
<% } %>    await waitForDatabase(pool);
<% } %><% if (educational) { %>    // Loading SQL from a file keeps schema changes visible in version control.
<% } %>    const schemaPath = path.join(process.cwd(), 'db', 'schema.sql');
    const schemaSql = await fs.readFile(schemaPath, 'utf8');
    await pool.query(schemaSql);
    console.log('Database schema applied.');
  } finally {
    await pool.end();
  }
}

run().catch((error) => {
<% if (educational) { %>  // Exit with a non-zero status so npm reports the script as failed.
<% } %>  console.error(error.message);
  process.exit(1);
});
